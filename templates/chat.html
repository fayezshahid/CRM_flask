{% extends "index.html" %}
{% block content %}
  <div class="container">
    <div class="row" style="margin-top: 50px;">
        <div class="col-md-4" style="padding: 0;">
          <div class="card">
            <div style="height: 75vh; overflow-y: scroll;" class="card-body">
                <!-- <div class="d-flex justify-content-between align-items-center">
                  <h5>Previous Chats</h5>
                  <button type="button" class="btn btn-outline-primary" style="margin-bottom: 10px;" onclick="newChat()">+ New Chat</button>
                </div> -->
                {% if role == 1 %}
                <nav>
                  <ul class="tabs">
                    <li id="all-tab" onclick="switchToAll()" class="active">All</li>
                    <li id="facebook-tab" onclick="switchToFb()">Facebook</li>
                    <li id="instagram-tab" onclick="switchToInsta()">Instagram</li>
                  </ul>
                </nav>
                {% endif %}
                <ul class="list-group" id="chats">
                  <!-- <li class="list-group-item bot-bubble rounded-bubble">Hi, how can I help you?</li> -->
                  <!-- <div class="list-group-item bot-bubble rounded-bubble">
                    <p></p>
                    <i class="fa fa-user"></i>
                  </div> -->
                </ul>
            </div>
          </div>
        </div>
        <div class="col-md-8" style="padding: 0;">
          <div class="card">
            <div style="height: 75vh" class="card-body">
              <div class="chat-header">
              </div>
              <div class="chat-box" style="display: none;">
                <!-- <div class="chat-message">
                    <div class="chat-bubble">Hi, how can I help you?</div>
                </div>
                <div class="chat-message">
                    <div class="chat-bubble">What is your name?</div>
                </div>
                <div class="chat-message">
                    <div class="chat-bubble">How old are you?</div>
                </div> -->
              </div>
              <form id="messagingBar" style="display: none;">
                <div class="form-group d-flex" style="margin-top: 5px;">
                  <input type="text" id="message" class="form-control" placeholder="Type your message...">
                  <button type="button" class="btn btn-outline-warning" style="margin-left: 5px;" onclick="triggerFileInput()">Attachment</button>
                  <input type="file" id="attachmentInput" style="display: none;" onchange="attach(event)">
                  <button type="button" class="btn btn-outline-primary" style="margin-left: 5px;" onclick="sendMessage()">Send</button>
                </div>
              </form>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="modal" id="allowToEnterChatModal" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered" role="document">
        <div class="modal-content">
            <div class="modal-body">
              <div class="input-group">
                <input type="search" id="usernameSearch" class="form-control" onsearch="cancel()">
                <button type="button" onclick="search()" class="btn btn-secondary">
                    <i class="fa-solid fa-search"></i>
                </button>
              </div>
              <div class="mt-3" id="employees" style="padding: 0 30px;">
              </div>
            </div>
        </div>
    </div>
  </div>
{% endblock %}

{% block scripts %}
<script>
    $(document).ready(function(){
      getConversations('all')
    })
    // console.log($('button'))
    function getConversations(platform){
      $('#chats').html('');
      $.get('/getConversations/' + platform, function(data){
        console.log(data)
        for(var i=0; i<data.length; i++){
          $('#chats').append(`
             <li class="list-group-item bot-bubble rounded-bubble d-flex justify-content-between" style="cursor: pointer;" id="chat${data[i].id}" onclick="getMessages('${data[i].id}')">${data[i].name}
          `)
          // console.log(name)
        }
      });
    }

    var current_recipient_id = 0;
    var current_conversation_id;

    function getMessages(id){
      // current_recipient_id = id;
      current_conversation_id = id;
      console.log(id);
      $('.chat-box').html('');
      $('.chat-header').html('');
      $('#messagingBar').show()
      $('.chat-box').show();
      $.get('/getMessages/' + id, function(data){
        console.log(data)
        $('.chat-header').html(`
          <div class="d-flex justify-content-between" style="margin-bottom: 10px">
            <h5 id="chatName">${data[0]}</h5>
            ${data[1].length ? `<button type="button" id="toggleRadioButtons" onclick="showRadioButtons()" class="btn btn-outline-secondary"><i class="fa-solid fa-share"></i></button>` : ''}
          </div>
        `);
        // $('.chat-header').html(`
        //   <div class="d-flex justify-content-between">
        //     <h5 id="chatName">${data[0]}</h5>
        //   </div>
        // `);
        data = data[1]
        for(var i=0; i<data.length; i++){
          if(i <= data.length - 2 && i > 0){
            const timestamp1 = new Date(data[i-1].timestamp);
            const timestamp2 = new Date(data[i].timestamp);

            // const timestamp1 = new Date(t1.getTime() + (5 * 60 * 60 * 1000));
            // const timestamp2 = new Date(t2.getTime() + (5 * 60 * 60 * 1000));

            const timeDifferenceInMilliseconds = timestamp1 - timestamp2;
            const timeDifferenceInMinutes = timeDifferenceInMilliseconds / (1000 * 60);
            console.log(timestamp1)
            console.log(timestamp2)
            let formattedDate = '';

            if (timeDifferenceInMinutes > 3) {
              const currentDate = new Date();
              // Calculate the time difference in milliseconds between the two dates
              const timeDifferenceInMilliseconds = Math.abs(currentDate - timestamp1);

              // Calculate the number of days between the two dates
              const daysDifference = timeDifferenceInMilliseconds / (1000 * 60 * 60 * 24);

              if (daysDifference <= 6) { // Checking if it's within a week (7 days)
                const options = {
                  weekday: 'short',
                  hour: 'numeric',
                  minute: 'numeric',
                  hour12: true
                };
                formattedDate = new Intl.DateTimeFormat('en-US', options).format(timestamp1); // Output: Wed 6:14 PM
              } else {
                // Display the original format, e.g., "Jul 25, 2023, 6:14 PM"
                formattedDate = new Intl.DateTimeFormat('en-US', {
                  year: 'numeric',
                  month: 'short',
                  day: 'numeric',
                  hour: 'numeric',
                  minute: 'numeric',
                  hour12: true
                }).format(timestamp1);
              }

              $('.chat-box').prepend(`
                <div class="d-flex justify-content-center date">
                  ${formattedDate}
                </div>
              `);
            }
          }

          if(data[i].from != "114887508325720" && data[i].from != "17841405286734922"){
            current_recipient_id = data[i].from;
            if(data[i].attachments.length > 0){
              for (var j = 0; j < data[i].attachments.length; j++) {
                var attachment = data[i].attachments[j];
                var attachmentElement;
                // console.log(attachment.type)
                if (attachment.type.includes("image")) {
                  attachmentElement = `<img src="${attachment.url}" alt="Sent Image">`;
                } 
                else if (attachment.type.includes("video")) {
                  attachmentElement = `
                    <div class="d-flex justify-content-between">
                        <span>${attachment.name}</span>
                        <a href="${attachment.url}" target="_blank" download>
                            <i class="fas fa-download"></i>
                        </a>
                    </div>
                  `;
                }
                else if (attachment.type.includes("application")) {
                  attachmentElement = `
                    <div class="d-flex justify-content-between">
                        <span>${attachment.name}</span>
                        <a href="${attachment.url}" target="_blank" download>
                            <i class="fas fa-download"></i>
                        </a>
                    </div>
                  `;
                }

                $('.chat-box').prepend(`
                    <div class='d-flex'>
                        <input type="radio" name="radio" onclick="allowToEnterChatModal('${id}', '${data[i].timestamp}')">
                        <div class="chat-message">
                            <div class="chat-bubble-response">
                                ${attachmentElement}
                            </div>
                        </div>
                    </div>
                `);
              }
            }
            else{
              $('.chat-box').prepend(`
                <div class='d-flex'>
                  <input type="radio" name="radio" onclick="allowToEnterChatModal('${id}', '${data[i].timestamp}')">
                  <div class="chat-message">
                      <div class="chat-bubble-response">${data[i].message}</div>
                  </div>
                </div>
              `);
            }
          }
          else{
            if(data[i].attachments.length > 0){
              for (var j = 0; j < data[i].attachments.length; j++) {
                var attachment = data[i].attachments[j];
                var attachmentElement;
                // console.log(attachment.type)
                if (attachment.type.includes("image")) {
                  attachmentElement = `<img src="${attachment.url}" alt="Sent Image">`;
                } 
                else if (attachment.type.includes("video")) {
                  attachmentElement = `
                    <div class="d-flex justify-content-between">
                        <span>${attachment.name}</span>
                        <a href="${attachment.url}" target="_blank" download>
                            <i class="fas fa-download"></i>
                        </a>
                    </div>
                  `;
                }
                else if (attachment.type.includes("application")) {
                  attachmentElement = `
                    <div class="d-flex justify-content-between">
                        <span>${attachment.name}</span>
                        <a href="${attachment.url}" target="_blank" download>
                            <i class="fas fa-download"></i>
                        </a>
                    </div>
                  `;
                }

                $('.chat-box').prepend(`
                    <div class='d-flex flex-row-reverse'>
                      <input type="radio" name="radio" onclick="allowToEnterChatModal('${id}', '${data[i].timestamp}')">
                      <div class="chat-message">
                          <div class="chat-bubble-send">
                              ${attachmentElement}
                          </div>
                      </div>
                    </div>
                `);
              }
            }
            else{
              $('.chat-box').prepend(`
                <div class='d-flex flex-row-reverse'>
                  <input type="radio" name="radio" onclick="allowToEnterChatModal('${id}', '${data[i].timestamp}')">
                  <div class="chat-message sent">
                      <div class="chat-bubble-send">${data[i].message}</div>
                  </div>
                </div>
              `);
            }
          }
        }
        var element = document.querySelector(".chat-box");
        element.scrollTop = element.scrollHeight;
      });
    }

    function showRadioButtons(){
      $('input[type="radio"]').each(function() {
        $(this).toggle();
      });
      $('#toggleRadioButtons').toggleClass('btn-secondary btn-outline-secondary');
    }

    function allowToEnterChatModal(conversation_id, timestamp){
      // imgId = id;
      console.log(timestamp)
      $('#usernameSearch').val('');
      $('#employees').html('');
      $.get('/getEmployeesToAllowEnterChat', function(data){
        output = '';
        for(var i=0; i<data.length; i++){
          var c = ''
          $.ajax({
            url: 'ifAllowed/' + data[i].id + '/' + conversation_id + '/' + timestamp,
            type: 'GET',
            async: false,
            success: function(res){
              if(res)
                c = 'checked'
            },
          });
          output += `
            <div class="d-flex justify-content-between align-items-center">
                <div class="">${data[i].username}</div>
                <input class="form-check-input" type="checkbox" onclick="allowToEnterChat(this, ${data[i].id}, '${conversation_id}', '${timestamp}')" ${c}>
            </div>
          `;
        }
        $('#employees').html(output);
      });
      $('#allowToEnterChatModal').modal('show');
    }

    function allowToEnterChat(checkbox, employee_id, conversation_id, timestamp){
      if(checkbox.checked){
        $.ajax({
          url: 'allowToEnterChat/' + employee_id + '/' + conversation_id + '/' + timestamp,
          type: 'POST',
          success: function(user){
            toastr.success('Shared chat with ' + user);
          },
          error: function(){
            toastr.error('Error');
          },
        });
      }
      else{
        $.ajax({
          url: 'unallowToEnterChat/' + employee_id + '/' + conversation_id + '/' + timestamp,
          type: 'POST',
          success: function(user){
            toastr.success('Unshared chat with ' + user);
          },
          error: function(){
            toastr.error('Error');
          },
        });
      }
    }

    function triggerFileInput() {
      document.getElementById('attachmentInput').click();
    }

    function attach(event) {
      
      const fileInput = event.target;
      const file = fileInput.files[0];
      
      // console.log('File attached');

      const formData = new FormData();
      formData.append('file', file);
      formData.append('recipient_id', current_recipient_id);
      formData.append('platform', current_tab)

      $.ajax({
        url: '/sendAttachment',
        method: 'POST',
        data: formData,
        processData: false,
        contentType: false
      })
      .done(function(data) {
        console.log(data)
        const reader = new FileReader();
        reader.onload = function(event) {
            const imageUrl = event.target.result;
            const chatBubble = `
              <div class='d-flex'>
                <div class="chat-message sent">
                    <div class="chat-bubble-send" style="margin-left: 235px !important">
                        <img width="420px" height="280px" src="${imageUrl}" alt="Sent Image">
                    </div>
                </div>
                <input type="radio" name="radio" onclick="allowToEnterChatModal('${current_conversation_id}', '${data}')">
              </div>
            `;
            $('.chat-box').append(chatBubble);
        };
        reader.readAsDataURL(file);
      })
    }

    function sendMessage(){
      var message = $('#message').val();

      $.post('/sendMessage', {'message': message, 'recipient_id': current_recipient_id, 'platform': current_tab}, function(data) {
        console.log(data);
        getConversations(current_tab);
        getMessages(current_conversation_id);
        $('#message').val('');
        var element = document.querySelector(".chat-box");
        element.scrollTop = element.scrollHeight;
      });
    }

    var socket = io.connect('http://localhost:5000');

    socket.on('connect', function() {
        console.log('Connected to the server');
    });

    socket.on('message_received', function(data) {
        // Handle the received message from the Flask route
        console.log('Received message:', data.message);
        getConversations(current_tab);
        getMessages(current_conversation_id)
        // if(current_conversation_id){
        //   $('.chat-box').append(`
        //     <div class='d-flex'>
        //       <input type="radio" name="radio" onclick="allowToEnterChatModal('${current_conversation_id}', '${data}')">
        //       <div class="chat-message">
        //           <div class="chat-bubble-response">${data.message}</div>
        //       </div>
        //     </div>
        //   `);
        //   var element = document.querySelector(".chat-box");
        //   element.scrollTop = element.scrollHeight;
        // }
        // Call your JavaScript function here
        // yourFunction();
    });

    var current_tab = 'all';

    function switchToFb(){
      current_tab = 'fb';
      $('#instagram-tab').removeClass('active')
      $('#all-tab').removeClass('active')
      $('#facebook-tab').addClass('active')
      getConversations('fb')
    }

    function switchToInsta(){
      current_tab = 'insta';
      $('#facebook-tab').removeClass('active')
      $('#all-tab').removeClass('active')
      $('#instagram-tab').addClass('active')
      getConversations('insta')
    }

    function switchToAll(){
      current_tab = 'all';
      $('#facebook-tab').removeClass('active')
      $('#instagram-tab').removeClass('active')
      $('#all-tab').addClass('active')
      getConversations('all')
    }

</script>
{% endblock %}
